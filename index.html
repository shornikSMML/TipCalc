<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A smart tip calculator with satisfaction slider, split bills, and more.">
  <meta name="theme-color" content="#6c63ff">
  <link rel="manifest" href="manifest.json">
  <title>Tip Calculator</title>
  <style>
    /* ===== CSS Custom Properties (Light/Dark) ===== */
    :root {
      --bg: #1a1a2e;
      --card-bg: #16213e;
      --input-bg: #0f1a30;
      --input-border: #2a3a5c;
      --results-bg: #0f1a30;
      --text: #e0e0e0;
      --text-muted: #8892b0;
      --text-dim: #5a6580;
      --heading: #fff;
      --value: #fff;
      --accent: #6c63ff;
      --accent-hover: #5a52e0;
      --divider: #1e2d4a;
      --shadow: rgba(0, 0, 0, 0.4);
      --btn-bg: #1e2d4a;
      --btn-text: #8892b0;
      --btn-active-bg: #6c63ff;
      --btn-active-text: #fff;
      --copy-bg: #6c63ff;
      --copy-text: #fff;
      --toggle-bg: #2a3a5c;
      --history-bg: #0f1a30;
      --history-item-bg: #16213e;
      --kbd-bg: #2a3a5c;
      --kbd-text: #8892b0;
      --overlay-bg: rgba(0, 0, 0, 0.6);
    }

    [data-theme="light"] {
      --bg: #f0f2f5;
      --card-bg: #ffffff;
      --input-bg: #f5f6f8;
      --input-border: #d0d5dd;
      --results-bg: #f5f6f8;
      --text: #333;
      --text-muted: #666;
      --text-dim: #999;
      --heading: #222;
      --value: #222;
      --accent: #6c63ff;
      --accent-hover: #5a52e0;
      --divider: #e0e0e0;
      --shadow: rgba(0, 0, 0, 0.1);
      --btn-bg: #e8eaed;
      --btn-text: #555;
      --btn-active-bg: #6c63ff;
      --btn-active-text: #fff;
      --copy-bg: #6c63ff;
      --copy-text: #fff;
      --toggle-bg: #d0d5dd;
      --history-bg: #f5f6f8;
      --history-item-bg: #fff;
      --kbd-bg: #e0e0e0;
      --kbd-text: #555;
      --overlay-bg: rgba(0, 0, 0, 0.4);
    }

    /* ===== Reset & Base ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    .sr-only {
      position: absolute; width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden;
      clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    /* ===== Card ===== */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 36px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px var(--shadow);
      animation: cardEntrance 0.5s ease-out;
      transition: background 0.3s, box-shadow 0.3s;
    }

    @keyframes cardEntrance {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (prefers-reduced-motion: reduce) {
      .card { animation: none; }
      * { transition-duration: 0s !important; animation-duration: 0s !important; }
    }

    /* ===== Header ===== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
    }

    h1 {
      font-size: 1.6rem;
      color: var(--heading);
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      background: var(--btn-bg);
      border: none;
      border-radius: 10px;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 1.2rem;
      transition: background 0.2s, transform 0.1s;
    }

    .icon-btn:hover { background: var(--accent); color: #fff; }
    .icon-btn:active { transform: scale(0.93); }
    .icon-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    /* ===== Labels & Inputs ===== */
    label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .input-group { margin-bottom: 24px; }

    .currency-input { position: relative; }

    .currency-input span {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.1rem;
      color: var(--text-muted);
    }

    input[type="number"] {
      width: 100%;
      padding: 14px 14px 14px 32px;
      font-size: 1.1rem;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--value);
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus { border-color: var(--accent); }
    input[type="number"]:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    input[type="number"]::-webkit-inner-spin-button { opacity: 0.5; }

    .people-input input { padding-left: 14px; }

    /* ===== Tax Toggle ===== */
    .tax-section { margin-bottom: 24px; }

    .tax-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .tax-toggle input[type="checkbox"] { display: none; }

    .tax-switch {
      width: 40px; height: 22px;
      background: var(--toggle-bg);
      border-radius: 11px;
      position: relative;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .tax-switch::after {
      content: '';
      position: absolute;
      width: 18px; height: 18px;
      background: #fff;
      border-radius: 50%;
      top: 2px; left: 2px;
      transition: transform 0.2s;
    }

    .tax-toggle input:checked + .tax-switch { background: var(--accent); }
    .tax-toggle input:checked + .tax-switch::after { transform: translateX(18px); }

    .tax-input-wrap {
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease;
    }

    .tax-input-wrap.open { max-height: 80px; }

    .tax-input-wrap .currency-input { margin-top: 10px; }

    /* ===== Preset Tips ===== */
    .presets {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .preset-btn {
      flex: 1;
      padding: 10px 4px;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--btn-bg);
      color: var(--btn-text);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .preset-btn:hover { border-color: var(--accent); color: var(--accent); }
    .preset-btn:active { transform: scale(0.95); }
    .preset-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .preset-btn[aria-pressed="true"] {
      background: var(--btn-active-bg);
      color: var(--btn-active-text);
      border-color: var(--btn-active-bg);
    }

    /* ===== Satisfaction Slider ===== */
    .slider-section { margin-bottom: 28px; }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
    }

    .slider-header .tip-pct {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent);
    }

    .satisfaction-track {
      position: relative;
      padding: 8px 0;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71);
      outline: none;
    }

    input[type="range"]:focus-visible { outline: 2px solid var(--accent); outline-offset: 4px; }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 3px solid var(--accent);
    }

    input[type="range"]::-moz-range-thumb {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 3px solid var(--accent);
    }

    .emoji-label {
      text-align: center;
      font-size: 1.1rem;
      margin-top: 8px;
      min-height: 1.4em;
    }

    .emoji-label .emoji {
      font-size: 1.4rem;
      margin-right: 6px;
      display: inline-block;
      transition: transform 0.2s;
    }

    .emoji-label .emoji.pop {
      transform: scale(1.3);
    }

    /* ===== Rounding Options ===== */
    .rounding-section { margin-bottom: 24px; }

    .segmented {
      display: flex;
      background: var(--btn-bg);
      border-radius: 12px;
      padding: 3px;
      gap: 2px;
    }

    .seg-btn {
      flex: 1;
      padding: 8px 4px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: var(--btn-text);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .seg-btn:hover { color: var(--accent); }
    .seg-btn:active { transform: scale(0.95); }
    .seg-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .seg-btn[aria-pressed="true"] {
      background: var(--accent);
      color: #fff;
    }

    /* ===== Results ===== */
    .results {
      background: var(--results-bg);
      border-radius: 14px;
      padding: 20px 24px;
      margin-bottom: 16px;
      transition: background 0.3s;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }

    .result-row + .result-row { border-top: 1px solid var(--divider); }

    .result-label { font-size: 0.9rem; color: var(--text-muted); }
    .result-label small { display: block; font-size: 0.75rem; color: var(--text-dim); }

    .result-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--value);
      transition: transform 0.15s;
    }

    .result-value.pop { transform: scale(1.08); }

    .result-row.total .result-value {
      color: var(--accent);
      font-size: 1.5rem;
    }

    /* ===== Action Buttons ===== */
    .actions {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: var(--copy-bg);
      color: var(--copy-text);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.2s, transform 0.1s;
    }

    .action-btn:hover { background: var(--accent-hover); }
    .action-btn:active { transform: scale(0.96); }
    .action-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .action-btn.secondary {
      background: var(--btn-bg);
      color: var(--text-muted);
    }

    .action-btn.secondary:hover { background: var(--accent); color: #fff; }

    /* ===== Advanced Split Mode ===== */
    .split-mode-section { margin-bottom: 24px; }

    .split-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .split-toggle input[type="checkbox"] { display: none; }

    .items-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .items-list.open { max-height: 500px; overflow-y: auto; }

    .item-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .item-row input {
      flex: 1;
      padding: 10px;
      font-size: 0.9rem;
      border: 2px solid var(--input-border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--value);
      outline: none;
    }

    .item-row input:focus { border-color: var(--accent); }

    .item-row .item-name { flex: 2; padding-left: 10px; }
    .item-row .item-price { padding-left: 32px; }

    .item-row .remove-item {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .item-row .remove-item:hover { background: rgba(231, 76, 60, 0.15); }

    .add-item-btn {
      width: 100%;
      padding: 10px;
      border: 2px dashed var(--input-border);
      border-radius: 10px;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .add-item-btn:hover { border-color: var(--accent); color: var(--accent); }

    .item-row .currency-prefix {
      position: relative;
    }

    .item-row .currency-prefix span {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* ===== History ===== */
    .history-section {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .history-section.open { max-height: 400px; }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .history-header h2 {
      font-size: 1rem;
      color: var(--heading);
      font-weight: 600;
    }

    .clear-history-btn {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      background: var(--history-item-bg);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .history-item:hover { opacity: 0.85; }

    .history-item-info { font-size: 0.85rem; color: var(--text-muted); }
    .history-item-info .amount { color: var(--value); font-weight: 600; font-size: 1rem; }
    .history-item-info .date { font-size: 0.75rem; color: var(--text-dim); }
    .history-item-total { color: var(--accent); font-weight: 700; font-size: 1.1rem; }

    /* ===== Keyboard Shortcuts Modal ===== */
    .shortcuts-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--overlay-bg);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .shortcuts-overlay.open { display: flex; }

    .shortcuts-modal {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 28px;
      max-width: 380px;
      width: 90%;
      box-shadow: 0 20px 60px var(--shadow);
    }

    .shortcuts-modal h2 {
      font-size: 1.2rem;
      color: var(--heading);
      margin-bottom: 16px;
      text-align: center;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .shortcut-row + .shortcut-row { border-top: 1px solid var(--divider); }

    .shortcut-desc { font-size: 0.85rem; color: var(--text-muted); }

    kbd {
      background: var(--kbd-bg);
      color: var(--kbd-text);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      font-weight: 600;
    }

    .close-modal-btn {
      display: block;
      margin: 18px auto 0;
      padding: 10px 24px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--accent);
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 200;
      pointer-events: none;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="card" role="main">
    <!-- Header -->
    <div class="header">
      <h1>Tip Calculator</h1>
      <div class="header-actions">
        <button class="icon-btn" id="historyBtn" aria-label="Toggle history" title="History">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </button>
        <button class="icon-btn" id="themeBtn" aria-label="Toggle light/dark mode" title="Toggle theme">
          <span id="themeIcon">&#9790;</span>
        </button>
        <button class="icon-btn" id="shortcutsBtn" aria-label="Keyboard shortcuts" title="Shortcuts (?)">
          <span>?</span>
        </button>
      </div>
    </div>

    <!-- Bill Amount -->
    <div class="input-group">
      <label for="bill">Bill Amount</label>
      <div class="currency-input">
        <span aria-hidden="true">$</span>
        <input type="number" id="bill" min="0" step="0.01" placeholder="0.00" inputmode="decimal" aria-label="Bill amount in dollars">
      </div>
    </div>

    <!-- Tax Toggle -->
    <div class="tax-section">
      <label class="tax-toggle">
        <input type="checkbox" id="taxToggle">
        <span class="tax-switch" aria-hidden="true"></span>
        <span>Includes tax?</span>
      </label>
      <div class="tax-input-wrap" id="taxInputWrap">
        <div class="currency-input">
          <span aria-hidden="true">$</span>
          <input type="number" id="taxAmount" min="0" step="0.01" placeholder="Tax amount" inputmode="decimal" aria-label="Tax amount in dollars">
        </div>
      </div>
    </div>

    <!-- Split Between -->
    <div class="input-group people-input">
      <label for="people">Split Between</label>
      <input type="number" id="people" min="1" step="1" value="1" placeholder="1" inputmode="numeric" aria-label="Number of people to split between">
    </div>

    <!-- Advanced Split Mode -->
    <div class="split-mode-section">
      <label class="split-toggle">
        <input type="checkbox" id="advancedSplitToggle">
        <span class="tax-switch" aria-hidden="true"></span>
        <span>Itemized split</span>
      </label>
      <div class="items-list" id="itemsList">
        <div id="itemsContainer"></div>
        <button class="add-item-btn" id="addItemBtn" type="button">+ Add Item</button>
      </div>
    </div>

    <!-- Preset Tips -->
    <div class="presets" role="group" aria-label="Preset tip percentages">
      <button class="preset-btn" data-pct="15" aria-pressed="false">15%</button>
      <button class="preset-btn" data-pct="18" aria-pressed="true">18%</button>
      <button class="preset-btn" data-pct="20" aria-pressed="false">20%</button>
      <button class="preset-btn" data-pct="25" aria-pressed="false">25%</button>
    </div>

    <!-- Satisfaction Slider -->
    <div class="slider-section">
      <div class="slider-header">
        <label for="satisfaction">Satisfaction</label>
        <span class="tip-pct" id="tipPct" aria-live="polite">18%</span>
      </div>
      <div class="satisfaction-track">
        <input type="range" id="satisfaction" min="0" max="100" value="60" aria-label="Satisfaction level â€” controls tip percentage">
      </div>
      <div class="emoji-label" id="emojiLabel" aria-live="polite"></div>
    </div>

    <!-- Rounding -->
    <div class="rounding-section">
      <label>Rounding</label>
      <div class="segmented" role="group" aria-label="Rounding options">
        <button class="seg-btn" data-round="exact" aria-pressed="true">Exact</button>
        <button class="seg-btn" data-round="total" aria-pressed="false">Round Total</button>
        <button class="seg-btn" data-round="tip" aria-pressed="false">Round Tip</button>
      </div>
    </div>

    <!-- Results -->
    <div class="results" aria-live="polite" aria-atomic="true">
      <div class="result-row">
        <div class="result-label">Tip<small id="perPersonLabel"></small></div>
        <div class="result-value" id="tipDisplay">$0.00</div>
      </div>
      <div class="result-row total">
        <div class="result-label">Total<small id="totalPerPersonLabel"></small></div>
        <div class="result-value" id="totalDisplay">$0.00</div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions">
      <button class="action-btn" id="copyBtn" aria-label="Copy result to clipboard">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Copy
      </button>
      <button class="action-btn secondary" id="resetBtn" aria-label="Reset calculator">
        Reset
      </button>
    </div>

    <!-- History -->
    <div class="history-section" id="historySection">
      <div class="history-header">
        <h2>History</h2>
        <button class="clear-history-btn" id="clearHistoryBtn">Clear All</button>
      </div>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div class="shortcuts-overlay" id="shortcutsOverlay" role="dialog" aria-modal="true" aria-label="Keyboard shortcuts">
    <div class="shortcuts-modal">
      <h2>Keyboard Shortcuts</h2>
      <div class="shortcut-row"><span class="shortcut-desc">15% preset</span><kbd>1</kbd></div>
      <div class="shortcut-row"><span class="shortcut-desc">18% preset</span><kbd>2</kbd></div>
      <div class="shortcut-row"><span class="shortcut-desc">20% preset</span><kbd>3</kbd></div>
      <div class="shortcut-row"><span class="shortcut-desc">25% preset</span><kbd>4</kbd></div>
      <div class="shortcut-row"><span class="shortcut-desc">Cycle rounding</span><kbd>R</kbd></div>
      <div class="shortcut-row"><span class="shortcut-desc">Copy result</span><kbd>C</kbd></div>
      <div class="shortcut-row"><span class="shortcut-desc">Reset</span><kbd>Esc</kbd></div>
      <div class="shortcut-row"><span class="shortcut-desc">This help</span><kbd>?</kbd></div>
      <button class="close-modal-btn" id="closeShortcuts">Close</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // ===== DOM References =====
    const billInput = document.getElementById('bill');
    const peopleInput = document.getElementById('people');
    const slider = document.getElementById('satisfaction');
    const tipPct = document.getElementById('tipPct');
    const emojiLabel = document.getElementById('emojiLabel');
    const tipDisplay = document.getElementById('tipDisplay');
    const totalDisplay = document.getElementById('totalDisplay');
    const perPersonLabel = document.getElementById('perPersonLabel');
    const totalPerPersonLabel = document.getElementById('totalPerPersonLabel');
    const taxToggle = document.getElementById('taxToggle');
    const taxInputWrap = document.getElementById('taxInputWrap');
    const taxAmountInput = document.getElementById('taxAmount');
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');
    const historyBtn = document.getElementById('historyBtn');
    const historySection = document.getElementById('historySection');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const copyBtn = document.getElementById('copyBtn');
    const resetBtn = document.getElementById('resetBtn');
    const shortcutsBtn = document.getElementById('shortcutsBtn');
    const shortcutsOverlay = document.getElementById('shortcutsOverlay');
    const closeShortcuts = document.getElementById('closeShortcuts');
    const toast = document.getElementById('toast');
    const advancedSplitToggle = document.getElementById('advancedSplitToggle');
    const itemsList = document.getElementById('itemsList');
    const itemsContainer = document.getElementById('itemsContainer');
    const addItemBtn = document.getElementById('addItemBtn');

    // ===== State =====
    let roundMode = 'exact';
    let history = JSON.parse(localStorage.getItem('tipHistory') || '[]');
    let items = [];

    // ===== Currency Formatting =====
    const currencyFmt = new Intl.NumberFormat(navigator.language || 'en-US', {
      style: 'currency', currency: 'USD', minimumFractionDigits: 2
    });

    function fmtCurrency(val) {
      return currencyFmt.format(val);
    }

    // ===== Satisfaction Levels =====
    const levels = [
      { max: 10,  emoji: '\u{1F620}', text: 'Terrible' },
      { max: 25,  emoji: '\u{1F615}', text: 'Poor' },
      { max: 45,  emoji: '\u{1F610}', text: 'Okay' },
      { max: 65,  emoji: '\u{1F642}', text: 'Good' },
      { max: 85,  emoji: '\u{1F60A}', text: 'Great' },
      { max: 100, emoji: '\u{1F929}', text: 'Amazing!' },
    ];

    function getTipPercent(val) {
      return (val / 100) * 30;
    }

    function getLevel(val) {
      return levels.find(l => val <= l.max) || levels[levels.length - 1];
    }

    // ===== Preset Buttons =====
    const presetBtns = document.querySelectorAll('.preset-btn');
    presetBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const pct = parseInt(btn.dataset.pct);
        const sliderVal = Math.round((pct / 30) * 100);
        slider.value = sliderVal;
        syncPresets(pct);
        update();
      });
    });

    function syncPresets(pct) {
      const rounded = Math.round(pct);
      presetBtns.forEach(b => {
        const match = parseInt(b.dataset.pct) === rounded;
        b.setAttribute('aria-pressed', match ? 'true' : 'false');
      });
    }

    // ===== Rounding Buttons =====
    const segBtns = document.querySelectorAll('.seg-btn');
    segBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        roundMode = btn.dataset.round;
        segBtns.forEach(b => b.setAttribute('aria-pressed', b === btn ? 'true' : 'false'));
        update();
      });
    });

    function cycleRounding() {
      const modes = ['exact', 'total', 'tip'];
      const idx = (modes.indexOf(roundMode) + 1) % modes.length;
      roundMode = modes[idx];
      segBtns.forEach(b => b.setAttribute('aria-pressed', b.dataset.round === roundMode ? 'true' : 'false'));
      update();
    }

    // ===== Tax Toggle =====
    taxToggle.addEventListener('change', () => {
      taxInputWrap.classList.toggle('open', taxToggle.checked);
      update();
    });

    taxAmountInput.addEventListener('input', update);

    // ===== Advanced Split =====
    advancedSplitToggle.addEventListener('change', () => {
      const open = advancedSplitToggle.checked;
      itemsList.classList.toggle('open', open);
      if (open && items.length === 0) addItem();
    });

    addItemBtn.addEventListener('click', addItem);

    function addItem() {
      const id = Date.now();
      items.push({ id, name: '', price: 0 });
      renderItems();
    }

    function removeItem(id) {
      items = items.filter(i => i.id !== id);
      renderItems();
      update();
    }

    function renderItems() {
      itemsContainer.innerHTML = '';
      items.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <input class="item-name" type="text" placeholder="Item ${idx + 1}" value="${item.name}" data-id="${item.id}" data-field="name">
          <div class="currency-prefix" style="position:relative;flex:1;">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:0.9rem;color:var(--text-muted);">$</span>
            <input class="item-price" type="number" min="0" step="0.01" placeholder="0.00" value="${item.price || ''}" inputmode="decimal" data-id="${item.id}" data-field="price" style="padding-left:28px;">
          </div>
          <button class="remove-item" data-id="${item.id}" aria-label="Remove item">&times;</button>
        `;
        itemsContainer.appendChild(row);
      });

      itemsContainer.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const id = parseInt(e.target.dataset.id);
          const field = e.target.dataset.field;
          const itm = items.find(i => i.id === id);
          if (itm) {
            itm[field] = field === 'price' ? parseFloat(e.target.value) || 0 : e.target.value;
            update();
          }
        });
      });

      itemsContainer.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', () => removeItem(parseInt(btn.dataset.id)));
      });
    }

    // ===== Main Update =====
    function update() {
      const val = parseInt(slider.value);
      const pct = getTipPercent(val);
      let bill = parseFloat(billInput.value) || 0;
      const people = Math.max(1, parseInt(peopleInput.value) || 1);
      const level = getLevel(val);

      // Tax-aware
      let taxableAmount = bill;
      if (taxToggle.checked) {
        const tax = parseFloat(taxAmountInput.value) || 0;
        taxableAmount = Math.max(0, bill - tax);
      }

      // If itemized mode, use items total as bill
      if (advancedSplitToggle.checked && items.length > 0) {
        const itemTotal = items.reduce((sum, i) => sum + (i.price || 0), 0);
        if (itemTotal > 0) {
          bill = itemTotal;
          taxableAmount = itemTotal;
          if (taxToggle.checked) {
            const tax = parseFloat(taxAmountInput.value) || 0;
            taxableAmount = Math.max(0, itemTotal - tax);
          }
        }
      }

      tipPct.textContent = Math.round(pct) + '%';
      syncPresets(pct);

      // Emoji with pop animation
      const emojiSpan = emojiLabel.querySelector('.emoji');
      emojiLabel.innerHTML = `<span class="emoji">${level.emoji}</span>${level.text}`;
      const newEmoji = emojiLabel.querySelector('.emoji');
      if (newEmoji) {
        newEmoji.classList.add('pop');
        setTimeout(() => newEmoji.classList.remove('pop'), 200);
      }

      let tip = taxableAmount * (pct / 100);
      let total = bill + tip;

      // Rounding
      if (roundMode === 'total') {
        total = Math.ceil(total);
        tip = total - bill;
      } else if (roundMode === 'tip') {
        tip = Math.ceil(tip);
        total = bill + tip;
      }

      const tipPerPerson = tip / people;
      const totalPerPerson = total / people;

      const displayTip = people > 1 ? tipPerPerson : tip;
      const displayTotal = people > 1 ? totalPerPerson : total;

      tipDisplay.textContent = fmtCurrency(displayTip);
      totalDisplay.textContent = fmtCurrency(displayTotal);

      // Pop animation on values
      tipDisplay.classList.add('pop');
      totalDisplay.classList.add('pop');
      setTimeout(() => {
        tipDisplay.classList.remove('pop');
        totalDisplay.classList.remove('pop');
      }, 150);

      perPersonLabel.textContent = people > 1 ? '/ person' : '';
      totalPerPersonLabel.textContent = people > 1 ? '/ person' : '';
    }

    // ===== Slider Events =====
    billInput.addEventListener('input', update);
    peopleInput.addEventListener('input', update);
    slider.addEventListener('input', update);

    // ===== Theme =====
    function getPreferredTheme() {
      const saved = localStorage.getItem('theme');
      if (saved) return saved;
      return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      themeIcon.innerHTML = theme === 'light' ? '&#9728;' : '&#9790;';
      localStorage.setItem('theme', theme);
    }

    themeBtn.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });

    applyTheme(getPreferredTheme());

    // ===== Copy / Share =====
    function getResultText() {
      const pct = tipPct.textContent;
      const tip = tipDisplay.textContent;
      const total = totalDisplay.textContent;
      const people = parseInt(peopleInput.value) || 1;
      let text = `Tip: ${tip} (${pct})`;
      if (people > 1) text += ` per person`;
      text += `\nTotal: ${total}`;
      if (people > 1) text += ` per person (${people} people)`;
      return text;
    }

    copyBtn.addEventListener('click', async () => {
      const text = getResultText();
      if (navigator.share) {
        try {
          await navigator.share({ title: 'Tip Calculator', text });
          showToast('Shared!');
          return;
        } catch (e) { /* user cancelled or not supported */ }
      }
      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard!');
      } catch (e) {
        showToast('Could not copy');
      }
      saveToHistory();
    });

    // ===== Reset =====
    resetBtn.addEventListener('click', resetCalculator);

    function resetCalculator() {
      billInput.value = '';
      peopleInput.value = '1';
      slider.value = 60;
      taxToggle.checked = false;
      taxInputWrap.classList.remove('open');
      taxAmountInput.value = '';
      roundMode = 'exact';
      segBtns.forEach(b => b.setAttribute('aria-pressed', b.dataset.round === 'exact' ? 'true' : 'false'));
      advancedSplitToggle.checked = false;
      itemsList.classList.remove('open');
      items = [];
      itemsContainer.innerHTML = '';
      update();
      showToast('Reset!');
    }

    // ===== Toast =====
    let toastTimeout;
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ===== History =====
    function saveToHistory() {
      const bill = parseFloat(billInput.value) || 0;
      if (bill === 0) return;
      const entry = {
        bill,
        tipPct: tipPct.textContent,
        tip: tipDisplay.textContent,
        total: totalDisplay.textContent,
        people: parseInt(peopleInput.value) || 1,
        date: new Date().toLocaleString()
      };
      history.unshift(entry);
      if (history.length > 20) history.pop();
      localStorage.setItem('tipHistory', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      historyList.innerHTML = '';
      if (history.length === 0) {
        historyList.innerHTML = '<div style="text-align:center;color:var(--text-dim);font-size:0.85rem;padding:12px;">No history yet</div>';
        return;
      }
      history.forEach((entry, idx) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.setAttribute('role', 'button');
        item.setAttribute('tabindex', '0');
        item.setAttribute('aria-label', `Bill ${fmtCurrency(entry.bill)}, total ${entry.total}`);
        item.innerHTML = `
          <div class="history-item-info">
            <div class="amount">${fmtCurrency(entry.bill)}</div>
            <div class="date">${entry.date} &middot; ${entry.tipPct}${entry.people > 1 ? ' &middot; ' + entry.people + ' people' : ''}</div>
          </div>
          <div class="history-item-total">${entry.total}</div>
        `;
        item.addEventListener('click', () => loadHistoryEntry(entry));
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); loadHistoryEntry(entry); }
        });
        historyList.appendChild(item);
      });
    }

    function loadHistoryEntry(entry) {
      billInput.value = entry.bill;
      peopleInput.value = entry.people;
      const pctNum = parseInt(entry.tipPct);
      slider.value = Math.round((pctNum / 30) * 100);
      update();
      historySection.classList.remove('open');
      showToast('Loaded from history');
    }

    historyBtn.addEventListener('click', () => {
      historySection.classList.toggle('open');
    });

    clearHistoryBtn.addEventListener('click', () => {
      history = [];
      localStorage.removeItem('tipHistory');
      renderHistory();
      showToast('History cleared');
    });

    renderHistory();

    // ===== Shortcuts Modal =====
    shortcutsBtn.addEventListener('click', () => shortcutsOverlay.classList.add('open'));
    closeShortcuts.addEventListener('click', () => shortcutsOverlay.classList.remove('open'));
    shortcutsOverlay.addEventListener('click', (e) => {
      if (e.target === shortcutsOverlay) shortcutsOverlay.classList.remove('open');
    });

    // ===== Keyboard Shortcuts =====
    document.addEventListener('keydown', (e) => {
      // Don't trigger when typing in inputs
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      if (e.key === '?') {
        e.preventDefault();
        shortcutsOverlay.classList.toggle('open');
      } else if (e.key === 'Escape') {
        if (shortcutsOverlay.classList.contains('open')) {
          shortcutsOverlay.classList.remove('open');
        } else {
          resetCalculator();
        }
      } else if (e.key === '1') {
        presetBtns[0].click();
      } else if (e.key === '2') {
        presetBtns[1].click();
      } else if (e.key === '3') {
        presetBtns[2].click();
      } else if (e.key === '4') {
        presetBtns[3].click();
      } else if (e.key.toLowerCase() === 'r') {
        cycleRounding();
      } else if (e.key.toLowerCase() === 'c') {
        copyBtn.click();
      }
    });

    // ===== Service Worker Registration =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }

    // ===== Init =====
    update();
  </script>
</body>
</html>
